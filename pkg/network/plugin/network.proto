syntax = "proto3";

package network;

option go_package = "github.com/b-harvest/devnet-builder/pkg/network/plugin";

// NetworkModule service definition
service NetworkModule {
    // Identity
    rpc Name(Empty) returns (StringResponse);
    rpc DisplayName(Empty) returns (StringResponse);
    rpc Version(Empty) returns (StringResponse);

    // Binary
    rpc BinaryName(Empty) returns (StringResponse);
    rpc BinarySource(Empty) returns (BinarySourceResponse);
    rpc DefaultBinaryVersion(Empty) returns (StringResponse);
    rpc GetBuildConfig(BuildConfigRequest) returns (BuildConfigResponse);

    // Chain
    // DEPRECATED: DefaultChainID will be removed in v2.0.0
    rpc DefaultChainID(Empty) returns (StringResponse);
    rpc Bech32Prefix(Empty) returns (StringResponse);
    rpc BaseDenom(Empty) returns (StringResponse);

    // Configuration
    rpc GenesisConfig(Empty) returns (GenesisConfigResponse);
    rpc DefaultPorts(Empty) returns (PortConfigResponse);
    rpc DefaultGeneratorConfig(Empty) returns (GeneratorConfigResponse);

    // Docker
    rpc DockerImage(Empty) returns (StringResponse);
    rpc DockerImageTag(StringRequest) returns (StringResponse);
    rpc DockerHomeDir(Empty) returns (StringResponse);

    // Commands
    rpc InitCommand(InitCommandRequest) returns (StringListResponse);
    rpc StartCommand(StringRequest) returns (StringListResponse);
    rpc ExportCommand(StringRequest) returns (StringListResponse);

    // Paths
    rpc DefaultNodeHome(Empty) returns (StringResponse);
    rpc PIDFileName(Empty) returns (StringResponse);
    rpc LogFileName(Empty) returns (StringResponse);
    rpc ProcessPattern(Empty) returns (StringResponse);

    // Operations
    rpc ModifyGenesis(ModifyGenesisRequest) returns (BytesResponse);
    rpc ModifyGenesisFile(ModifyGenesisFileRequest) returns (ModifyGenesisFileResponse);
    rpc GenerateDevnet(GenerateDevnetRequest) returns (ErrorResponse);
    rpc GetCodec(Empty) returns (BytesResponse);

    // Validation
    rpc Validate(Empty) returns (ErrorResponse);

    // Snapshot
    rpc SnapshotURL(StringRequest) returns (StringResponse);
    rpc RPCEndpoint(StringRequest) returns (StringResponse);
    rpc AvailableNetworks(Empty) returns (StringListResponse);

    // Node Configuration
    rpc GetConfigOverrides(NodeConfigRequest) returns (ConfigOverridesResponse);
}

message Empty {}

message StringRequest {
    string value = 1;
}

message StringResponse {
    string value = 1;
}

message StringListResponse {
    repeated string values = 1;
}

message BytesResponse {
    bytes data = 1;
    string error = 2;
}

message ErrorResponse {
    string error = 1;
}

message BinarySourceResponse {
    string type = 1;
    string owner = 2;
    string repo = 3;
    string local_path = 4;
    string asset_name = 5;
    repeated string build_tags = 6;
}

message PortConfigResponse {
    int32 rpc = 1;
    int32 p2p = 2;
    int32 grpc = 3;
    int32 grpc_web = 4;
    int32 api = 5;
    int32 evm_rpc = 6;
    int32 evm_socket = 7;
}

message GenesisConfigResponse {
    string chain_id_pattern = 1;
    int64 evm_chain_id = 2;
    string base_denom = 3;
    int32 denom_exponent = 4;
    string display_denom = 5;
    string bond_denom = 6;
    string min_self_delegation = 7;
    int64 unbonding_time_seconds = 8;
    uint32 max_validators = 9;
    string min_deposit = 10;
    int64 voting_period_seconds = 11;
    int64 max_deposit_period_seconds = 12;
    string community_tax = 13;
}

message GeneratorConfigResponse {
    int32 num_validators = 1;
    int32 num_accounts = 2;
    string account_balance = 3;
    string validator_balance = 4;
    string validator_stake = 5;
    string output_dir = 6;
    string chain_id = 7;
}

message InitCommandRequest {
    string home_dir = 1;
    string chain_id = 2;
    string moniker = 3;
}

message ValidatorInfo {
    string moniker = 1;
    string cons_pub_key = 2;
    string operator_address = 3;
    string self_delegation = 4;
}

message ModifyGenesisRequest {
    bytes genesis = 1;
    string chain_id = 2;
    int32 num_validators = 3;
    repeated ValidatorInfo validators = 4;
}

message GenerateDevnetRequest {
    int32 num_validators = 1;
    int32 num_accounts = 2;
    string account_balance = 3;
    string validator_balance = 4;
    string validator_stake = 5;
    string output_dir = 6;
    string chain_id = 7;
    string genesis_file = 8;
}

message NodeConfigRequest {
    int32 node_index = 1;
    string chain_id = 2;
    PortConfigResponse ports = 3;
    string persistent_peers = 4;
    int32 num_validators = 5;
    bool is_validator = 6;
    string moniker = 7;
}

message ConfigOverridesResponse {
    bytes config_toml = 1;
    bytes app_toml = 2;
    string error = 3;
}

// ModifyGenesisFileRequest uses file paths instead of raw bytes
// to handle large genesis files that exceed gRPC message limits.
message ModifyGenesisFileRequest {
    string input_path = 1;   // Path to input genesis.json
    string output_path = 2;  // Path where modified genesis should be written
    string chain_id = 3;
    int32 num_validators = 4;
    repeated ValidatorInfo validators = 5;
}

message ModifyGenesisFileResponse {
    string error = 1;
    int64 output_size = 2;   // Size of the output file in bytes
}

// BuildConfigRequest requests build configuration for a specific network type.
message BuildConfigRequest {
    string network_type = 1;  // Target network type (e.g., "mainnet", "testnet", "devnet")
}

// BuildConfigResponse contains network-specific build configuration.
message BuildConfigResponse {
    repeated string tags = 1;           // Go build tags (e.g., ["netgo", "ledger"])
    repeated string ldflags = 2;        // Linker flags (e.g., ["-X main.Version=1.0", "-w"])
    map<string, string> env = 3;        // Environment variables (e.g., {"CGO_ENABLED": "0"})
    repeated string extra_args = 4;     // Additional arguments for build tool
    string error = 5;                   // Error message if network type not supported
}
