// Devnet API Protocol Buffers
// This file defines the gRPC service for managing devnets via the daemon.

syntax = "proto3";

package devnetbuilder.v1;

import "google/protobuf/timestamp.proto";

option go_package = "github.com/altuslabsxyz/devnet-builder/api/proto/gen/v1;devnetbuilderv1";

// DevnetService provides operations for managing devnets.
service DevnetService {
  // Lifecycle
  rpc CreateDevnet(CreateDevnetRequest) returns (CreateDevnetResponse);
  rpc GetDevnet(GetDevnetRequest) returns (GetDevnetResponse);
  rpc ListDevnets(ListDevnetsRequest) returns (ListDevnetsResponse);
  rpc DeleteDevnet(DeleteDevnetRequest) returns (DeleteDevnetResponse);
  rpc StartDevnet(StartDevnetRequest) returns (StartDevnetResponse);
  rpc StopDevnet(StopDevnetRequest) returns (StopDevnetResponse);
  // Apply creates or updates a devnet from YAML spec
  rpc ApplyDevnet(ApplyDevnetRequest) returns (ApplyDevnetResponse);
  // Update modifies an existing devnet
  rpc UpdateDevnet(UpdateDevnetRequest) returns (UpdateDevnetResponse);
  // StreamProvisionLogs streams provisioning logs for a devnet
  rpc StreamProvisionLogs(StreamProvisionLogsRequest) returns (stream StreamProvisionLogsResponse);
}

// Devnet represents a local development network.
message Devnet {
  DevnetMetadata metadata = 1;
  DevnetSpec spec = 2;
  DevnetStatus status = 3;
}

message DevnetMetadata {
  string name = 1;
  int64 generation = 2;
  google.protobuf.Timestamp created_at = 3;
  google.protobuf.Timestamp updated_at = 4;
  map<string, string> labels = 5;
  map<string, string> annotations = 6;
  string namespace = 7;  // Namespace for resource isolation (defaults to "default")
}

message DevnetSpec {
  string plugin = 1;  // Network plugin name (e.g., "stable", "osmosis")
  string network_type = 2;  // "cosmos", "evm", "tempo"
  int32 validators = 3;
  int32 full_nodes = 4;
  string mode = 5;  // "docker" or "local"
  string sdk_version = 6;  // Binary version
  string genesis_path = 7;  // Custom genesis file path
  string snapshot_url = 8;  // Chain state snapshot URL
  string rpc_url = 9;  // RPC endpoint URL for genesis forking
  string fork_network = 10;  // Network to fork from (e.g., "mainnet", "testnet") - used to fetch plugin defaults
  string chain_id = 11;  // Chain ID for the devnet (e.g., "mainnet-1", "mydevnet-1")
}

message DevnetStatus {
  string phase = 1;
  int32 nodes = 2;
  int32 ready_nodes = 3;
  int64 current_height = 4;
  string sdk_version = 5;
  google.protobuf.Timestamp last_health_check = 6;
  string message = 7;
  repeated Condition conditions = 8;            // Detailed status conditions
  repeated Event events = 9;                    // Recent events (last 10)
  uint32 subnet = 10;                           // Allocated loopback subnet (1-254) for 127.0.X.0/24
}

// Condition represents a status condition of a resource.
message Condition {
  string type = 1;                              // Type of condition (Ready, Progressing, etc.)
  string status = 2;                            // True, False, Unknown
  google.protobuf.Timestamp last_transition_time = 3;
  string reason = 4;                            // CamelCase reason code
  string message = 5;                           // Human-readable message
}

// Event represents a significant occurrence during resource lifecycle.
message Event {
  google.protobuf.Timestamp timestamp = 1;
  string type = 2;                              // Normal, Warning
  string reason = 3;                            // CamelCase reason code
  string message = 4;                           // Human-readable message
  string component = 5;                         // Source component (controller, runtime, etc.)
}

// DevnetService request/response messages
message CreateDevnetRequest {
  string name = 1;
  DevnetSpec spec = 2;
  map<string, string> labels = 3;
  string namespace = 4;  // Target namespace (defaults to "default")
}

message CreateDevnetResponse {
  Devnet devnet = 1;
}

message GetDevnetRequest {
  string name = 1;
  string namespace = 2;  // Namespace to look in (defaults to "default")
}

message GetDevnetResponse {
  Devnet devnet = 1;
}

message ListDevnetsRequest {
  string label_selector = 1;
  string namespace = 2;  // Filter by namespace, empty = all namespaces
}

message ListDevnetsResponse {
  repeated Devnet devnets = 1;
}

message DeleteDevnetRequest {
  string name = 1;
  string namespace = 2;  // Namespace (defaults to "default")
}

message DeleteDevnetResponse {
  bool deleted = 1;
}

message StartDevnetRequest {
  string name = 1;
  string namespace = 2;  // Namespace (defaults to "default")
}

message StartDevnetResponse {
  Devnet devnet = 1;
}

message StopDevnetRequest {
  string name = 1;
  string namespace = 2;  // Namespace (defaults to "default")
}

message StopDevnetResponse {
  Devnet devnet = 1;
}

message ApplyDevnetRequest {
  string name = 1;
  DevnetSpec spec = 2;
  map<string, string> labels = 3;
  map<string, string> annotations = 4;
  string namespace = 5;  // Namespace (defaults to "default")
}

message ApplyDevnetResponse {
  Devnet devnet = 1;
  string action = 2;  // "created", "configured", "unchanged"
}

message UpdateDevnetRequest {
  string name = 1;
  DevnetSpec spec = 2;
  map<string, string> labels = 3;
  map<string, string> annotations = 4;
  string namespace = 5;  // Namespace (defaults to "default")
}

message UpdateDevnetResponse {
  Devnet devnet = 1;
}

message StreamProvisionLogsRequest {
  string namespace = 1;
  string name = 2;
}

message StreamProvisionLogsResponse {
  google.protobuf.Timestamp timestamp = 1;
  string level = 2;      // "info", "warn", "error"
  string message = 3;    // Log line
  string phase = 4;      // Current phase when log was emitted
}

// =============================================================================
// Node - Individual blockchain node within a devnet
// =============================================================================

// Node represents a single blockchain node within a devnet.
message Node {
  NodeMetadata metadata = 1;
  NodeSpec spec = 2;
  NodeStatus status = 3;
}

message NodeMetadata {
  string id = 1;  // UUID for global lookup
  string devnet_name = 2;  // Parent devnet reference
  int32 index = 3;  // Index within devnet (0-based)
  int64 generation = 4;
  google.protobuf.Timestamp created_at = 5;
  google.protobuf.Timestamp updated_at = 6;
  string namespace = 7;  // Parent devnet's namespace (defaults to "default")
}

message NodeSpec {
  string role = 1;  // "validator" or "fullnode"
  string binary_path = 2;
  string home_dir = 3;
  string desired_phase = 4;  // "Running" or "Stopped"
  NodeRestartPolicy restart_policy = 5;
  string address = 6;  // Node IP address (e.g., "127.0.42.1") for loopback subnet aliasing
}

enum NodeRestartPolicy {
  NODE_RESTART_POLICY_UNSPECIFIED = 0;
  NODE_RESTART_POLICY_NEVER = 1;
  NODE_RESTART_POLICY_ON_FAILURE = 2;
  NODE_RESTART_POLICY_ALWAYS = 3;
}

message NodeStatus {
  string phase = 1;  // Pending, Starting, Running, Stopping, Stopped, Unhealthy
  string container_id = 2;
  int32 pid = 3;
  NodeHealth health = 4;
  int64 block_height = 5;
  int32 peer_count = 6;
  bool catching_up = 7;
  int32 restart_count = 8;
  string message = 9;
  int64 observed_generation = 10;
}

message NodeHealth {
  string status = 1;  // Unknown, Healthy, Unhealthy, Degraded
  string message = 2;
  google.protobuf.Timestamp last_check = 3;
  int32 consecutive_failures = 4;
}

// NodeService provides operations for managing individual nodes within devnets.
service NodeService {
  // Lifecycle
  rpc StartNode(StartNodeRequest) returns (StartNodeResponse);
  rpc StopNode(StopNodeRequest) returns (StopNodeResponse);
  rpc RestartNode(RestartNodeRequest) returns (RestartNodeResponse);

  // Observation
  rpc GetNode(GetNodeRequest) returns (GetNodeResponse);
  rpc ListNodes(ListNodesRequest) returns (ListNodesResponse);
  rpc GetNodeHealth(GetNodeHealthRequest) returns (GetNodeHealthResponse);
  rpc StreamNodeLogs(StreamNodeLogsRequest) returns (stream StreamNodeLogsResponse);
  rpc GetNodePorts(GetNodePortsRequest) returns (GetNodePortsResponse);

  // Mutation
  rpc ExecInNode(ExecInNodeRequest) returns (ExecInNodeResponse);
}

// NodeService request/response messages
message StartNodeRequest {
  string devnet_name = 1;
  int32 index = 2;
  string namespace = 3;  // Namespace (defaults to "default")
}

message StartNodeResponse {
  Node node = 1;
}

message StopNodeRequest {
  string devnet_name = 1;
  int32 index = 2;
  int32 timeout_seconds = 3;  // Grace period, default 30
  string namespace = 4;  // Namespace (defaults to "default")
}

message StopNodeResponse {
  Node node = 1;
}

message RestartNodeRequest {
  string devnet_name = 1;
  int32 index = 2;
  string namespace = 3;  // Namespace (defaults to "default")
}

message RestartNodeResponse {
  Node node = 1;
}

message GetNodeRequest {
  string devnet_name = 1;
  int32 index = 2;
  string namespace = 3;  // Namespace (defaults to "default")
}

message GetNodeResponse {
  Node node = 1;
}

message ListNodesRequest {
  string devnet_name = 1;  // Required: filter by devnet
  string namespace = 2;  // Namespace (defaults to "default")
}

message ListNodesResponse {
  repeated Node nodes = 1;
}

message GetNodeHealthRequest {
  string devnet_name = 1;
  int32 index = 2;
  string namespace = 3;  // Namespace (defaults to "default")
}

message GetNodeHealthResponse {
  NodeHealth health = 1;
}

message StreamNodeLogsRequest {
  string devnet_name = 1;
  int32 index = 2;
  bool follow = 3;
  string since = 4;  // RFC3339 timestamp
  int32 tail = 5;    // Number of lines from end
  string namespace = 6;  // Namespace (defaults to "default")
}

message StreamNodeLogsResponse {
  google.protobuf.Timestamp timestamp = 1;
  string stream = 2;  // "stdout" or "stderr"
  string message = 3;
}

message ExecInNodeRequest {
  string devnet_name = 1;
  int32 index = 2;
  repeated string command = 3;
  int32 timeout_seconds = 4;
  string namespace = 5;  // Namespace (defaults to "default")
}

message ExecInNodeResponse {
  int32 exit_code = 1;
  string stdout = 2;
  string stderr = 3;
}

// PortMapping describes a single port binding between container and host.
message PortMapping {
  string name = 1;           // Service name: "p2p", "rpc", "rest", "grpc"
  int32 container_port = 2;  // Port inside container (e.g., 26656)
  int32 host_port = 3;       // Port on host (e.g., 26756 for node index 1)
  string protocol = 4;       // "tcp" or "udp"
}

message GetNodePortsRequest {
  string devnet_name = 1;
  int32 index = 2;
}

message GetNodePortsResponse {
  string devnet_name = 1;
  int32 index = 2;
  repeated PortMapping ports = 3;
}

// =============================================================================
// Upgrade - Chain upgrade operation for a devnet
// =============================================================================

// Upgrade represents a chain upgrade operation.
message Upgrade {
  UpgradeMetadata metadata = 1;
  UpgradeSpec spec = 2;
  UpgradeStatus status = 3;
}

message UpgradeMetadata {
  string name = 1;  // Unique upgrade name
  int64 generation = 2;
  google.protobuf.Timestamp created_at = 3;
  google.protobuf.Timestamp updated_at = 4;
  string namespace = 5;  // Namespace for isolation (defaults to "default")
}

message UpgradeSpec {
  string devnet_ref = 1;  // Target devnet name
  string upgrade_name = 2;  // On-chain upgrade name
  int64 target_height = 3;  // Block height for upgrade (0 = auto-calculate)
  BinarySource new_binary = 4;  // Upgraded binary source
  bool with_export = 5;  // Enable state export before/after
  bool auto_vote = 6;  // Auto-vote yes with all validators
  // Field 7 reserved for future use
  string namespace = 8;  // Namespace for the devnet reference (defaults to "default")
}

message BinarySource {
  string type = 1;  // "cache", "url", "local"
  string version = 2;  // Version identifier
  string url = 3;  // URL for remote binary (if type=url)
  string path = 4;  // Local path (if type=local)
}

message UpgradeStatus {
  string phase = 1;  // Pending, Proposing, Voting, Waiting, Switching, Verifying, Completed, Failed
  uint64 proposal_id = 2;  // Governance proposal ID
  int32 votes_received = 3;
  int32 votes_required = 4;
  int64 current_height = 5;
  string pre_export_path = 6;  // Path to pre-upgrade state export
  string post_export_path = 7;  // Path to post-upgrade state export
  string message = 8;
  string error = 9;  // Error details if phase is Failed
}

// UpgradeService provides operations for managing chain upgrades.
service UpgradeService {
  // Lifecycle
  rpc CreateUpgrade(CreateUpgradeRequest) returns (CreateUpgradeResponse);
  rpc GetUpgrade(GetUpgradeRequest) returns (GetUpgradeResponse);
  rpc ListUpgrades(ListUpgradesRequest) returns (ListUpgradesResponse);
  rpc DeleteUpgrade(DeleteUpgradeRequest) returns (DeleteUpgradeResponse);

  // Actions
  rpc CancelUpgrade(CancelUpgradeRequest) returns (CancelUpgradeResponse);
  rpc RetryUpgrade(RetryUpgradeRequest) returns (RetryUpgradeResponse);
}

// UpgradeService request/response messages
message CreateUpgradeRequest {
  string name = 1;  // Unique upgrade name
  UpgradeSpec spec = 2;
  string namespace = 3;  // Namespace (defaults to "default")
}

message CreateUpgradeResponse {
  Upgrade upgrade = 1;
}

message GetUpgradeRequest {
  string name = 1;
  string namespace = 2;  // Namespace (defaults to "default")
}

message GetUpgradeResponse {
  Upgrade upgrade = 1;
}

message ListUpgradesRequest {
  string devnet_name = 1;  // Optional: filter by devnet
  string namespace = 2;  // Namespace (defaults to "default", empty = all namespaces)
}

message ListUpgradesResponse {
  repeated Upgrade upgrades = 1;
}

message DeleteUpgradeRequest {
  string name = 1;
  string namespace = 2;  // Namespace (defaults to "default")
}

message DeleteUpgradeResponse {
  bool deleted = 1;
}

message CancelUpgradeRequest {
  string name = 1;
  string namespace = 2;  // Namespace (defaults to "default")
}

message CancelUpgradeResponse {
  Upgrade upgrade = 1;
}

message RetryUpgradeRequest {
  string name = 1;
  string namespace = 2;  // Namespace (defaults to "default")
}

message RetryUpgradeResponse {
  Upgrade upgrade = 1;
}

// =============================================================================
// Network - Network module discovery and information
// =============================================================================

// NetworkService provides operations for discovering available network modules.
service NetworkService {
  // ListNetworks returns all registered network modules.
  rpc ListNetworks(ListNetworksRequest) returns (ListNetworksResponse);
  // GetNetworkInfo returns detailed information about a specific network module.
  rpc GetNetworkInfo(GetNetworkInfoRequest) returns (GetNetworkInfoResponse);
  // ListBinaryVersions returns available binary versions for a network.
  // This fetches releases from the network's binary source (e.g., GitHub).
  rpc ListBinaryVersions(ListBinaryVersionsRequest) returns (ListBinaryVersionsResponse);
}

// ListNetworksRequest is the request message for ListNetworks.
message ListNetworksRequest {}

// ListNetworksResponse is the response message for ListNetworks.
message ListNetworksResponse {
  repeated NetworkSummary networks = 1;
}

// NetworkSummary provides a brief overview of a network module.
message NetworkSummary {
  string name = 1;                          // Unique identifier (e.g., "stable", "cosmos")
  string display_name = 2;                  // Human-readable name
  string version = 3;                       // Module version
  string binary_name = 4;                   // CLI binary name (e.g., "stabled")
  repeated string available_networks = 5;   // Supported network types (e.g., ["mainnet", "testnet"])
  string default_binary_version = 6;        // Default binary version
}

// GetNetworkInfoRequest is the request message for GetNetworkInfo.
message GetNetworkInfoRequest {
  string name = 1;  // Network module name
}

// GetNetworkInfoResponse is the response message for GetNetworkInfo.
message GetNetworkInfoResponse {
  NetworkInfo network = 1;
}

// NetworkInfo provides detailed information about a network module.
message NetworkInfo {
  string name = 1;                          // Unique identifier
  string display_name = 2;                  // Human-readable name
  string version = 3;                       // Module version
  string binary_name = 4;                   // CLI binary name
  string default_binary_version = 5;        // Default binary version
  NetworkBinarySource binary_source = 6;    // Binary source configuration
  string bech32_prefix = 7;                 // Address prefix (e.g., "stable", "cosmos")
  string base_denom = 8;                    // Base token denom (e.g., "ustable", "uatom")
  string default_chain_id = 9;              // Default chain ID for devnets
  map<string, EndpointInfo> endpoints = 10; // Network endpoints by network type
  string docker_image = 11;                 // Docker image name
  string docker_home_dir = 12;              // Home directory inside Docker
  NetworkPortConfig default_ports = 13;     // Default port configuration
}

// NetworkBinarySource describes how to acquire the network binary.
message NetworkBinarySource {
  string type = 1;        // "github" or "local"
  string owner = 2;       // GitHub owner (if type="github")
  string repo = 3;        // GitHub repo (if type="github")
  string local_path = 4;  // Local path (if type="local")
}

// EndpointInfo contains RPC and snapshot endpoints for a network type.
message EndpointInfo {
  string rpc_endpoint = 1;   // RPC endpoint URL
  string snapshot_url = 2;   // Snapshot download URL
}

// NetworkPortConfig contains default port configuration for a network.
message NetworkPortConfig {
  int32 rpc = 1;        // Tendermint RPC port (default: 26657)
  int32 p2p = 2;        // P2P port (default: 26656)
  int32 grpc = 3;       // gRPC port (default: 9090)
  int32 grpc_web = 4;   // gRPC-Web port (default: 9091)
  int32 api = 5;        // REST API port (default: 1317)
  int32 evm_rpc = 6;    // EVM JSON-RPC port (default: 8545)
  int32 evm_socket = 7; // EVM WebSocket port (default: 8546)
}

// =============================================================================
// Binary Versions - List available binary versions for a network
// =============================================================================

// ListBinaryVersionsRequest is the request for ListBinaryVersions.
message ListBinaryVersionsRequest {
  string network_name = 1;      // Required: network plugin name (e.g., "stable")
  bool include_prerelease = 2;  // Optional: include prerelease versions (default: false)
}

// ListBinaryVersionsResponse is the response for ListBinaryVersions.
message ListBinaryVersionsResponse {
  string network_name = 1;                    // Network plugin name
  repeated BinaryVersionInfo versions = 2;   // Available versions, newest first
  string default_version = 3;                 // Default version for this network
  string source_type = 4;                     // Binary source type: "github", "local"
}

// BinaryVersionInfo describes a single binary version.
message BinaryVersionInfo {
  string tag = 1;                              // Version tag (e.g., "v1.0.0")
  string name = 2;                             // Release name/title
  bool prerelease = 3;                         // Whether this is a prerelease
  google.protobuf.Timestamp published_at = 4; // Publication timestamp
  string html_url = 5;                         // URL to the release page
}

// =============================================================================
// Auth - Authentication service for remote access
// =============================================================================

// AuthService provides authentication and identity operations.
service AuthService {
  // Ping verifies connectivity and authentication to the server.
  rpc Ping(PingRequest) returns (PingResponse);
  // WhoAmI returns information about the authenticated user.
  rpc WhoAmI(WhoAmIRequest) returns (WhoAmIResponse);
}

// PingRequest is the request for Ping.
message PingRequest {}

// PingResponse is the response for Ping.
message PingResponse {
  string server_version = 1;  // Server version string
}

// WhoAmIRequest is the request for WhoAmI.
message WhoAmIRequest {}

// WhoAmIResponse is the response for WhoAmI.
message WhoAmIResponse {
  string name = 1;                // User name from API key
  repeated string namespaces = 2; // Allowed namespaces (["*"] = all)
}
