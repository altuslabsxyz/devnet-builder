services:
  node0:
    image: ${STABLED_IMAGE:-ghcr.io/stablelabs/stable}:${STABLED_TAG:-latest-testnet}
    container_name: stabled-node0
    hostname: node0
    user: "0"
    command: ["start", "--home", "/data"]
    volumes:
      - ./devnet/node0/config:/data/config:ro
      - ./devnet/node0/keyring-test:/data/keyring-test:ro
      - ./devnet/node0/data:/data/data
    ports:
      - "${NODE0_RPC_PORT:-26657}:6657"        # CometBFT RPC
      - "${NODE0_P2P_PORT:-26656}:6656"        # P2P
      - "${NODE0_EVM_PORT:-8545}:8545"         # EVM JSON-RPC
      - "${NODE0_GRPC_PORT:-9090}:9090"        # gRPC
      - "${NODE0_METRICS_PORT:-26660}:6660"    # Prometheus metrics
    environment:
      - STABLED_LOG_LEVEL=${STABLED_LOG_LEVEL:-info}
    networks:
      - stabled-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6657/status"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 10s

  node1:
    image: ${STABLED_IMAGE:-ghcr.io/stablelabs/stable}:${STABLED_TAG:-latest-testnet}
    container_name: stabled-node1
    hostname: node1
    user: "0"
    command: ["start", "--home", "/data"]
    volumes:
      - ./devnet/node1/config:/data/config:ro
      - ./devnet/node1/keyring-test:/data/keyring-test:ro
      - ./devnet/node1/data:/data/data
    ports:
      - "${NODE1_RPC_PORT:-36657}:6657"        # CometBFT RPC
      - "${NODE1_P2P_PORT:-36656}:6656"        # P2P
      - "${NODE1_EVM_PORT:-18545}:8545"        # EVM JSON-RPC
      - "${NODE1_GRPC_PORT:-19090}:9090"       # gRPC
      - "${NODE1_METRICS_PORT:-36660}:6660"    # Prometheus metrics
    environment:
      - STABLED_LOG_LEVEL=${STABLED_LOG_LEVEL:-info}
    networks:
      - stabled-network
    restart: unless-stopped
    depends_on:
      node0:
        condition: service_started
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6657/status"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 10s

  node2:
    image: ${STABLED_IMAGE:-ghcr.io/stablelabs/stable}:${STABLED_TAG:-latest-testnet}
    container_name: stabled-node2
    hostname: node2
    user: "0"
    command: ["start", "--home", "/data"]
    volumes:
      - ./devnet/node2/config:/data/config:ro
      - ./devnet/node2/keyring-test:/data/keyring-test:ro
      - ./devnet/node2/data:/data/data
    ports:
      - "${NODE2_RPC_PORT:-46657}:6657"        # CometBFT RPC
      - "${NODE2_P2P_PORT:-46656}:6656"        # P2P
      - "${NODE2_EVM_PORT:-28545}:8545"        # EVM JSON-RPC
      - "${NODE2_GRPC_PORT:-29090}:9090"       # gRPC
      - "${NODE2_METRICS_PORT:-46660}:6660"    # Prometheus metrics
    environment:
      - STABLED_LOG_LEVEL=${STABLED_LOG_LEVEL:-info}
    networks:
      - stabled-network
    restart: unless-stopped
    depends_on:
      node0:
        condition: service_started
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6657/status"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 10s

  node3:
    image: ${STABLED_IMAGE:-ghcr.io/stablelabs/stable}:${STABLED_TAG:-latest-testnet}
    container_name: stabled-node3
    hostname: node3
    user: "0"
    command: ["start", "--home", "/data"]
    volumes:
      - ./devnet/node3/config:/data/config:ro
      - ./devnet/node3/keyring-test:/data/keyring-test:ro
      - ./devnet/node3/data:/data/data
    ports:
      - "${NODE3_RPC_PORT:-56657}:6657"        # CometBFT RPC
      - "${NODE3_P2P_PORT:-56656}:6656"        # P2P
      - "${NODE3_EVM_PORT:-38545}:8545"        # EVM JSON-RPC
      - "${NODE3_GRPC_PORT:-39090}:9090"       # gRPC
      - "${NODE3_METRICS_PORT:-56660}:6660"    # Prometheus metrics
    environment:
      - STABLED_LOG_LEVEL=${STABLED_LOG_LEVEL:-info}
    networks:
      - stabled-network
    restart: unless-stopped
    depends_on:
      node0:
        condition: service_started
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6657/status"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 10s

networks:
  stabled-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16
