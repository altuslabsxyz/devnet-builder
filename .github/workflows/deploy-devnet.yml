name: Deploy Devnet

run-name: Devnet-${{ inputs.target_chain_id }}-${{ github.run_number }}

on:
  workflow_dispatch:
    inputs:
      stable_tag:
        description: 'Stable repository tag version (optional, defaults to stable-devnet tag)'
        required: false
        type: string
        default: ''
      target_chain_id:
        description: 'Target chain-id to export'
        required: true
        type: choice
        options:
          - stabletestnet_2200-1
        default: 'stabletestnet_2200-1'
      target_rpc_endpoint:
        description: 'Target chain RPC endpoint (e.g., https://stable-rpc.testnet.chain0.dev/)'
        required: false
        type: string
        default: 'https://stable-rpc.testnet.chain0.dev/'
      validators:
        description: 'Number of validators to create'
        required: true
        type: number
        default: 4
      accounts:
        description: 'Number of dummy accounts to create'
        required: true
        type: number
        default: 10
      account_balance:
        description: 'Balance for each account (optional, e.g., "1000000000000000000000astable,500000000000000000000agasusdt")'
        required: false
        type: string
        default: ''
      validator_balance:
        description: 'Balance for each validator (optional, e.g., "1000000000000000000000astable,500000000000000000000agasusdt")'
        required: false
        type: string
        default: ''
      validator_stake:
        description: 'Stake amount for each validator in astable (optional)'
        required: false
        type: string
        default: ''
      devnet_chain_id:
        description: 'Devnet Chain ID (optional, defaults to from genesis)'
        required: false
        type: string
        default: ''
      devnet_base_dir:
        description: 'Base directory to deploy devnet nodes'
        required: true
        type: string
        default: '/data/.devnet'

jobs:
  deploy-devnet:
    runs-on: [self-hosted, ubuntu]

    env:
      TARGET_CHAIN_ID: ${{ inputs.target_chain_id }}
      TARGET_RPC_ENDPOINT: ${{ inputs.target_rpc_endpoint }}
      STABLE_TAG: ${{ inputs.stable_tag }}
      VALIDATORS: ${{ inputs.validators }}
      ACCOUNTS: ${{ inputs.accounts }}
      ACCOUNT_BALANCE: ${{ inputs.account_balance }}
      VALIDATOR_BALANCE: ${{ inputs.validator_balance }}
      VALIDATOR_STAKE: ${{ inputs.validator_stake }}
      DEVNET_CHAIN_ID: ${{ inputs.devnet_chain_id }}
      DEVNET_OUTPUT_DIR: './devnet'
      DEVNET_BASE_DIR: ${{ inputs.devnet_base_dir }}

    steps:
      - name: Checkout stable-devnet repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Get current tag version
        id: get_tag
        run: |
          if [ -n "${{ env.STABLE_TAG }}" ]; then
            TAG="${{ env.STABLE_TAG }}"
            echo "Using provided tag: $TAG"
          else
            TAG=$(git describe --tags --exact-match 2>/dev/null || git describe --tags --abbrev=0 2>/dev/null || echo "")
            if [ -z "$TAG" ]; then
              echo "Error: No tag found and no tag provided"
              exit 1
            fi
            echo "Using current repository tag: $TAG"
          fi
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "STABLE_TAG=$TAG" >> $GITHUB_ENV

      - name: Setup Go
        uses: actions/setup-go@v3
        with:
          go-version: "^1.22"

      - name: Configure Git to use PAT
        run: |
          git config --global url."https://${{ secrets.GH_PAT }}:@github.com/".insteadOf "https://github.com/"
          echo "GOPRIVATE=github.com/stablelabs/*" >> $GITHUB_ENV

      - name: Setup stable repository symbolic link
        id: setup_stable_link
        run: |
          STABLE_LINK_PATH="${GITHUB_WORKSPACE}/stable"
          EXPECTED_TAG="${{ steps.get_tag.outputs.tag }}"
          STABLE_REPO_URL="https://github.com/stablelabs/stable.git"

          echo "Setting up stable repository symbolic link in current repository..."
          echo "Expected tag: $EXPECTED_TAG"
          echo "Stable repository URL: $STABLE_REPO_URL"

          # Remove existing symbolic link if exists
          if [ -L "$STABLE_LINK_PATH" ]; then
            echo "Removing existing symbolic link..."
            rm -f "$STABLE_LINK_PATH"
          fi

          # Remove directory if exists
          if [ -d "$STABLE_LINK_PATH" ]; then
            echo "Warning: stable/ directory exists but is not a symbolic link. Removing..."
            rm -rf "$STABLE_LINK_PATH"
          fi

          # Search for existing stable repository clones
          STABLE_SEARCH_PATHS=(
            "/data/stable"
            "/data/.stable"
            "$HOME/stable"
            "$HOME/.stable"
            "/opt/stable"
            "/tmp/stable-cache"
          )

          STABLE_REPO_PATH=""
          for SEARCH_PATH in "${STABLE_SEARCH_PATHS[@]}"; do
            if [ -d "$SEARCH_PATH/.git" ]; then
              cd "$SEARCH_PATH"
              # Check if it's the correct repository
              REMOTE_URL=$(git config --get remote.origin.url 2>/dev/null || echo "")
              if [[ "$REMOTE_URL" == *"stablelabs/stable"* ]]; then
                STABLE_REPO_PATH="$SEARCH_PATH"
                echo "Found existing stable repository at: $STABLE_REPO_PATH"
                break
              fi
            fi
          done

          # Clone stable repository if not found
          if [ -z "$STABLE_REPO_PATH" ]; then
            echo "Stable repository not found. Cloning..."
            STABLE_REPO_PATH="/tmp/stable-cache"

            if [ -d "$STABLE_REPO_PATH" ]; then
              rm -rf "$STABLE_REPO_PATH"
            fi

            git clone "$STABLE_REPO_URL" "$STABLE_REPO_PATH"
            echo "Cloned stable repository to: $STABLE_REPO_PATH"
          else
            # Fetch latest tags from existing repository
            echo "Fetching latest tags..."
            cd "$STABLE_REPO_PATH"
            git fetch --tags --force
          fi

          # Checkout the correct tag
          cd "$STABLE_REPO_PATH"
          echo "Checking out tag: $EXPECTED_TAG"

          if ! git rev-parse "$EXPECTED_TAG" >/dev/null 2>&1; then
            echo "Error: Tag $EXPECTED_TAG does not exist in stable repository"
            echo "Available tags:"
            git tag | tail -20
            exit 1
          fi

          git checkout "$EXPECTED_TAG"

          # Verify checkout
          CURRENT_TAG=$(git describe --tags --exact-match 2>/dev/null || echo "")
          if [ "$CURRENT_TAG" != "$EXPECTED_TAG" ]; then
            echo "Error: Failed to checkout tag $EXPECTED_TAG (current: $CURRENT_TAG)"
            exit 1
          fi

          echo "Successfully checked out tag: $CURRENT_TAG"

          # Create symbolic link in current repository
          cd "$GITHUB_WORKSPACE"
          ln -sf "$STABLE_REPO_PATH" "$STABLE_LINK_PATH"

          # Verify symbolic link
          if [ ! -L "$STABLE_LINK_PATH" ]; then
            echo "Error: Failed to create symbolic link"
            exit 1
          fi

          LINK_TARGET=$(readlink -f "$STABLE_LINK_PATH")
          echo "Symbolic link created: $STABLE_LINK_PATH -> $LINK_TARGET"

          # Verify the link points to correct version
          cd "$STABLE_LINK_PATH"
          VERIFY_TAG=$(git describe --tags --exact-match 2>/dev/null || echo "")
          echo "Verified stable version: $VERIFY_TAG"

          if [ "$VERIFY_TAG" != "$EXPECTED_TAG" ]; then
            echo "Error: Symbolic link points to wrong version (expected: $EXPECTED_TAG, got: $VERIFY_TAG)"
            exit 1
          fi

          echo "stable_path=$STABLE_LINK_PATH" >> $GITHUB_OUTPUT

      - name: Build stabled binary
        id: build_stabled
        run: |
          STABLE_PATH="${{ steps.setup_stable_link.outputs.stable_path }}"

          echo "Building stabled binary from: $STABLE_PATH"
          cd "$STABLE_PATH"

          # Clean previous builds
          make clean || true

          # Build stabled with proper environment variables
          echo "Running make build..."
          GOARCH=amd64 LEDGER_ENABLED=false make build

          # Verify build output
          if [ ! -f "./build/stabled" ]; then
            echo "Error: stabled binary not found at ./build/stabled"
            ls -la ./build/ || echo "Build directory not found"
            exit 1
          fi

          echo "Build successful"
          ./build/stabled version
          echo "stabled_binary=$STABLE_PATH/build/stabled" >> $GITHUB_OUTPUT

      - name: Provision and sync target chain
        id: export_genesis
        run: |
          STABLE_PATH="${{ steps.setup_stable_link.outputs.stable_path }}"
          STABLED_BINARY="${{ steps.build_stabled.outputs.stabled_binary }}"
          GENESIS_EXPORT_PATH="${GITHUB_WORKSPACE}/genesis-export.json"

          echo "Provisioning and syncing target chain..."
          echo "Target Chain ID: $TARGET_CHAIN_ID"
          echo "Target RPC Endpoint: $TARGET_RPC_ENDPOINT"
          echo "Using stabled binary: $STABLED_BINARY"

          # Make provision script executable
          chmod +x "${GITHUB_WORKSPACE}/scripts/provision-and-sync.sh"

          # Run provision and sync script
          "${GITHUB_WORKSPACE}/scripts/provision-and-sync.sh" \
            --chain-id "$TARGET_CHAIN_ID" \
            --rpc-endpoint "$TARGET_RPC_ENDPOINT" \
            --stabled-binary "$STABLED_BINARY" \
            --base-dir "/data" \
            --output-file "$GENESIS_EXPORT_PATH"

          # Verify export
          if [ ! -f "$GENESIS_EXPORT_PATH" ]; then
            echo "Error: Genesis export failed"
            exit 1
          fi

          GENESIS_SIZE=$(stat -f%z "$GENESIS_EXPORT_PATH" 2>/dev/null || stat -c%s "$GENESIS_EXPORT_PATH" 2>/dev/null)
          echo "Genesis exported successfully (size: $GENESIS_SIZE bytes)"

          # Validate JSON
          if ! jq empty "$GENESIS_EXPORT_PATH" 2>/dev/null; then
            echo "Error: Exported genesis is not valid JSON"
            exit 1
          fi

          echo "genesis_file=$GENESIS_EXPORT_PATH" >> $GITHUB_OUTPUT

      - name: Build devnet with devnet-builder
        id: build_devnet
        run: |
          GENESIS_FILE="${{ steps.export_genesis.outputs.genesis_file }}"

          echo "Building devnet using devnet-builder..."
          echo "Genesis file: $GENESIS_FILE"
          echo "Validators: $VALIDATORS"
          echo "Accounts: $ACCOUNTS"
          if [ -n "$ACCOUNT_BALANCE" ]; then
            echo "Account balance: $ACCOUNT_BALANCE"
          else
            echo "Account balance: (using default)"
          fi
          if [ -n "$VALIDATOR_BALANCE" ]; then
            echo "Validator balance: $VALIDATOR_BALANCE"
          else
            echo "Validator balance: (using default)"
          fi
          if [ -n "$VALIDATOR_STAKE" ]; then
            echo "Validator stake: $VALIDATOR_STAKE"
          else
            echo "Validator stake: (using default)"
          fi
          echo "Devnet Chain ID: $DEVNET_CHAIN_ID"
          echo "Output directory: $DEVNET_OUTPUT_DIR"

          # Build devnet-builder if not exists
          if [ ! -f "./build/devnet-builder" ]; then
            echo "Building devnet-builder..."
            make build
          fi

          # Build command
          BUILD_CMD="./build/devnet-builder build \"$GENESIS_FILE\" \
            --validators $VALIDATORS \
            --accounts $ACCOUNTS"

          # Add optional balance and stake parameters if provided
          if [ -n "$ACCOUNT_BALANCE" ]; then
            BUILD_CMD="$BUILD_CMD --account-balance \"$ACCOUNT_BALANCE\""
          fi

          if [ -n "$VALIDATOR_BALANCE" ]; then
            BUILD_CMD="$BUILD_CMD --validator-balance \"$VALIDATOR_BALANCE\""
          fi

          if [ -n "$VALIDATOR_STAKE" ]; then
            BUILD_CMD="$BUILD_CMD --validator-stake \"$VALIDATOR_STAKE\""
          fi

          # Add output directory
          BUILD_CMD="$BUILD_CMD --output \"$DEVNET_OUTPUT_DIR\""

          # Add chain-id if provided
          if [ -n "$DEVNET_CHAIN_ID" ]; then
            BUILD_CMD="$BUILD_CMD --chain-id \"$DEVNET_CHAIN_ID\""
          fi

          echo "Executing: $BUILD_CMD"
          eval $BUILD_CMD

          # Verify devnet creation
          if [ ! -d "$DEVNET_OUTPUT_DIR" ]; then
            echo "Error: Devnet directory not created"
            exit 1
          fi

          echo "Devnet created successfully"
          ls -la "$DEVNET_OUTPUT_DIR"

          # Count created nodes
          NODE_COUNT=$(find "$DEVNET_OUTPUT_DIR" -maxdepth 1 -type d -name "node*" | wc -l)
          echo "Created $NODE_COUNT validator nodes"

          if [ "$NODE_COUNT" -ne "$VALIDATORS" ]; then
            echo "Warning: Expected $VALIDATORS nodes but found $NODE_COUNT"
          fi

          # Extract actual chain-id from genesis if not provided
          if [ -z "$DEVNET_CHAIN_ID" ]; then
            ACTUAL_CHAIN_ID=$(jq -r '.chain_id' "$DEVNET_OUTPUT_DIR/node0/config/genesis.json")
            echo "Extracted chain-id from genesis: $ACTUAL_CHAIN_ID"
            echo "actual_chain_id=$ACTUAL_CHAIN_ID" >> $GITHUB_OUTPUT
          else
            echo "actual_chain_id=$DEVNET_CHAIN_ID" >> $GITHUB_OUTPUT
          fi

      - name: Upload devnet artifact
        uses: actions/upload-artifact@v4
        with:
          name: devnet-${{ steps.get_tag.outputs.tag }}-${{ github.run_number }}
          path: ${{ env.DEVNET_OUTPUT_DIR }}
          retention-days: 30
          compression-level: 9

      - name: Deploy devnet to system
        id: deploy_devnet
        run: |
          echo "Deploying devnet to $DEVNET_BASE_DIR..."

          # Create base directory if not exists
          sudo mkdir -p "$DEVNET_BASE_DIR"
          sudo chown -R $(whoami):$(whoami) "$DEVNET_BASE_DIR"

          # Backup existing devnet if exists
          if [ -d "$DEVNET_BASE_DIR" ] && [ "$(ls -A $DEVNET_BASE_DIR)" ]; then
            BACKUP_DIR="${DEVNET_BASE_DIR}_backup_$(date +%Y%m%d_%H%M%S)"
            echo "Backing up existing devnet to: $BACKUP_DIR"
            sudo mv "$DEVNET_BASE_DIR" "$BACKUP_DIR"
            sudo mkdir -p "$DEVNET_BASE_DIR"
            sudo chown -R $(whoami):$(whoami) "$DEVNET_BASE_DIR"
          fi

          # Copy devnet files to system directory
          echo "Copying devnet files to $DEVNET_BASE_DIR..."
          cp -r "$DEVNET_OUTPUT_DIR"/* "$DEVNET_BASE_DIR/"

          # Verify deployment
          echo "Verifying deployment..."
          ls -la "$DEVNET_BASE_DIR"

          # Count deployed nodes
          NODE_COUNT=$(find "$DEVNET_BASE_DIR" -maxdepth 1 -type d -name "node*" | wc -l)
          echo "Deployed $NODE_COUNT validator nodes to $DEVNET_BASE_DIR"

      - name: Stop existing screen sessions
        id: stop_screens
        run: |
          echo "Stopping existing devnet screen sessions..."

          # Find and stop all node screen sessions
          for i in $(seq 0 $((VALIDATORS - 1))); do
            NODE_NAME="node$i"
            if screen -list | grep -q "\.$NODE_NAME\s"; then
              echo "Stopping screen session: $NODE_NAME"
              screen -S "$NODE_NAME" -X quit || true
            fi
          done

          echo "All existing screen sessions stopped"

      - name: Start devnet nodes with screen
        id: start_nodes
        run: |
          STABLE_PATH="${{ steps.setup_stable_link.outputs.stable_path }}"
          STABLED_BINARY="$STABLE_PATH/build/stabled"
          ACTUAL_CHAIN_ID="${{ steps.build_devnet.outputs.actual_chain_id }}"

          echo "Starting devnet nodes with screen..."
          echo "Using stabled binary: $STABLED_BINARY"
          echo "Chain ID: $ACTUAL_CHAIN_ID"

          # Verify stabled binary exists
          if [ ! -f "$STABLED_BINARY" ]; then
            echo "Error: stabled binary not found at $STABLED_BINARY"
            exit 1
          fi

          # Make sure stabled is executable
          chmod +x "$STABLED_BINARY"

          # Start each validator node
          for i in $(seq 0 $((VALIDATORS - 1))); do
            NODE_NAME="node$i"
            NODE_HOME="$DEVNET_BASE_DIR/$NODE_NAME"
            LOG_FILE="$DEVNET_BASE_DIR/$NODE_NAME.log"

            echo "Starting $NODE_NAME..."
            echo "  Home: $NODE_HOME"
            echo "  Log: $LOG_FILE"

            # Verify node directory exists
            if [ ! -d "$NODE_HOME" ]; then
              echo "Error: Node directory not found: $NODE_HOME"
              exit 1
            fi

            # Create new screen session with logging
            screen -dmS "$NODE_NAME" -L -Logfile "$LOG_FILE" \
              bash -c "cd $STABLE_PATH && ./build/stabled start --home $NODE_HOME --chain-id $ACTUAL_CHAIN_ID; exec bash"

            # Wait a moment for the screen to start
            sleep 2

            # Verify screen session is running
            if screen -list | grep -q "\.$NODE_NAME\s"; then
              echo "$NODE_NAME started successfully"
            else
              echo "Warning: Failed to start screen session for $NODE_NAME"
            fi
          done

          echo ""
          echo "All nodes started. Screen sessions:"
          screen -list

      - name: Verify nodes are running
        id: verify_nodes
        run: |
          echo "Waiting for nodes to start..."
          sleep 10

          echo "Verifying screen sessions..."
          screen -list

          # Check if all screen sessions are running
          RUNNING_COUNT=0
          for i in $(seq 0 $((VALIDATORS - 1))); do
            NODE_NAME="node$i"
            if screen -list | grep -q "\.$NODE_NAME\s"; then
              RUNNING_COUNT=$((RUNNING_COUNT + 1))
              echo "$NODE_NAME is running"
            else
              echo "Warning: $NODE_NAME is not running"
            fi
          done

          echo ""
          echo "Summary: $RUNNING_COUNT/$VALIDATORS nodes are running"

          if [ "$RUNNING_COUNT" -ne "$VALIDATORS" ]; then
            echo "Warning: Not all nodes are running"
          fi

          # Display log file locations
          echo ""
          echo "Log files:"
          for i in $(seq 0 $((VALIDATORS - 1))); do
            LOG_FILE="$DEVNET_BASE_DIR/node$i.log"
            if [ -f "$LOG_FILE" ]; then
              echo "  node$i: $LOG_FILE"
            fi
          done

      - name: Display deployment summary
        id: summary
        run: |
          ACTUAL_CHAIN_ID="${{ steps.build_devnet.outputs.actual_chain_id }}"

          echo ""
          echo "=========================================="
          echo "Devnet Deployment Summary"
          echo "=========================================="
          echo "Target Chain ID: $TARGET_CHAIN_ID"
          echo "Target RPC Endpoint: $TARGET_RPC_ENDPOINT"
          echo "Stable Tag: ${{ steps.get_tag.outputs.tag }}"
          echo "Devnet Chain ID: $ACTUAL_CHAIN_ID"
          echo "Validators: $VALIDATORS"
          echo "Accounts: $ACCOUNTS"
          echo "Devnet Directory: $DEVNET_BASE_DIR"
          echo "=========================================="
          echo ""
          echo "Screen Sessions:"
          screen -list
          echo ""
          echo "Devnet Structure:"
          ls -la "$DEVNET_BASE_DIR"
          echo ""
          echo "Log Files:"
          for i in $(seq 0 $((VALIDATORS - 1))); do
            LOG_FILE="$DEVNET_BASE_DIR/node$i.log"
            if [ -f "$LOG_FILE" ]; then
              LOG_SIZE=$(stat -f%z "$LOG_FILE" 2>/dev/null || stat -c%s "$LOG_FILE" 2>/dev/null)
              echo "  node$i: $LOG_FILE ($LOG_SIZE bytes)"
            fi
          done
          echo ""
          echo "To view node logs:"
          echo "  tail -f $DEVNET_BASE_DIR/node0.log"
          echo ""
          echo "To attach to screen session:"
          echo "  screen -r node0"
          echo ""
          echo "=========================================="
