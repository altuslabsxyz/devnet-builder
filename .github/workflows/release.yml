# GitHub Actions workflow for GoReleaser v2
# Triggers on push of tags starting with 'v' (e.g., v1.0.0, v2.1.0-beta)
# Builds binaries for multiple platforms, Docker images, and creates GitHub releases

name: Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      tag:
        description: "Version tag (e.g., v1.0.0)"
        required: true
        type: string

# Do not cancel release workflows - they must complete
concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: write
  packages: write
  id-token: write

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  goreleaser:
    name: GoReleaser
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch all tags
        run: git fetch --force --tags

      - name: Determine version
        id: version
        run: |
          if [ -n "${{ inputs.tag }}" ]; then
            VERSION="${{ inputs.tag }}"
          else
            VERSION="${GITHUB_REF#refs/tags/}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Install Cosign
        uses: sigstore/cosign-installer@v3

      - name: Install Syft (for SBOM generation)
        uses: anchore/sbom-action/download-syft@v0

      - name: Run GoReleaser
        uses: goreleaser/goreleaser-action@v6
        with:
          distribution: goreleaser
          version: "~> v2"
          args: release --clean
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          COSIGN_EXPERIMENTAL: 1
          GOWORK: off

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-artifacts
          path: |
            dist/*.tar.gz
            dist/*.zip
            dist/*.txt
          retention-days: 30

  announce:
    name: Release Summary
    needs: goreleaser
    runs-on: ubuntu-latest
    if: success()

    steps:
      - name: Get release info
        id: release
        uses: actions/github-script@v7
        with:
          script: |
            const tag = context.ref.replace('refs/tags/', '');
            try {
              const { data: release } = await github.rest.repos.getReleaseByTag({
                owner: context.repo.owner,
                repo: context.repo.repo,
                tag: tag
              });
              console.log(`Release ${release.tag_name} created successfully!`);
              console.log(`URL: ${release.html_url}`);
              core.setOutput('url', release.html_url);
              return release;
            } catch (error) {
              console.log(`Release info not available yet: ${error.message}`);
              core.setOutput('url', `https://github.com/${context.repo.owner}/${context.repo.repo}/releases/tag/${tag}`);
            }

      - name: Create Summary
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          echo "## Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Release Information" >> $GITHUB_STEP_SUMMARY
          echo "- **Tag**: \`${TAG}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Actor**: @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Docker Images" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "# Pull the latest release" >> $GITHUB_STEP_SUMMARY
          echo "docker pull ghcr.io/altuslabsxyz/devnet-builder:${TAG}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Or use the latest tag" >> $GITHUB_STEP_SUMMARY
          echo "docker pull ghcr.io/altuslabsxyz/devnet-builder:latest" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Binary Downloads" >> $GITHUB_STEP_SUMMARY
          echo "| Platform | Architecture | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Linux | amd64, arm64 | Available |" >> $GITHUB_STEP_SUMMARY
          echo "| macOS | amd64, arm64, universal | Available |" >> $GITHUB_STEP_SUMMARY
          echo "| Windows | amd64 | Available |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Quick Install" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "# Linux (amd64)" >> $GITHUB_STEP_SUMMARY
          echo "curl -LO https://github.com/altuslabsxyz/devnet-builder/releases/download/${TAG}/devnet-builder_\${TAG#v}_linux_amd64.tar.gz" >> $GITHUB_STEP_SUMMARY
          echo "tar -xzf devnet-builder_\${TAG#v}_linux_amd64.tar.gz" >> $GITHUB_STEP_SUMMARY
          echo "sudo mv devnet-builder /usr/local/bin/" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
