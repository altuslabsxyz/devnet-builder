name: Deploy Devnet & Upgrade

run-name: Devnet-Upgrade-${{ inputs.snapshot_network }}-${{ inputs.source_image_tag }}-to-${{ inputs.upgrade_image_tag }}-${{ github.run_number }}

on:
  workflow_dispatch:
    inputs:
      snapshot_network:
        description: 'Snapshot network to fork from'
        required: true
        type: choice
        options:
          - testnet
          - mainnet
        default: 'testnet'
      source_image_tag:
        description: 'Source Docker image tag (for initial devnet)'
        required: true
        type: string
        default: 'latest-testnet'
      upgrade_image_tag:
        description: 'Target Docker image tag after upgrade'
        required: true
        type: string
      upgrade_name:
        description: 'Upgrade handler name registered in new binary'
        required: true
        type: string
      validators:
        description: 'Number of validators'
        required: false
        type: string
        default: '4'

env:
  STABLED_IMAGE: ghcr.io/stablelabs/stable
  DEVNET_BASE_DIR: /data/.devnet

jobs:
  deploy-and-upgrade:
    runs-on: [self-hosted, ubuntu]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Login to GitHub Container Registry
        run: |
          echo "${{ secrets.GH_PAT }}" | docker login ghcr.io -u qj0r9j0vc2 --password-stdin

      - name: Pull Docker images
        run: |
          SOURCE_IMAGE="${STABLED_IMAGE}:${{ inputs.source_image_tag }}"
          UPGRADE_IMAGE="${STABLED_IMAGE}:${{ inputs.upgrade_image_tag }}"

          echo "Pulling source image: $SOURCE_IMAGE"
          docker pull "$SOURCE_IMAGE"

          echo "Pulling upgrade image: $UPGRADE_IMAGE"
          docker pull "$UPGRADE_IMAGE"

      - name: Install tools
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq lz4 zstd jq

      - name: Build devnet-builder
        env:
          GOPRIVATE: github.com/stablelabs/*
        run: |
          git config --global url."https://${{ secrets.GH_PAT }}@github.com/".insteadOf "https://github.com/"
          go clean -cache -modcache 2>/dev/null || true
          go mod download
          make build

      - name: Stop existing services
        run: |
          echo "Stopping existing services..."
          "${GITHUB_WORKSPACE}/build/devnet-builder" down --home "$DEVNET_BASE_DIR" 2>/dev/null || true
          docker rm -f devnet-node0 devnet-node1 devnet-node2 devnet-node3 2>/dev/null || true
          sleep 5

      - name: Deploy devnet with source binary
        run: |
          SOURCE_IMAGE="${STABLED_IMAGE}:${{ inputs.source_image_tag }}"

          echo "Deploying devnet with source binary..."
          echo "  Network: ${{ inputs.snapshot_network }}"
          echo "  Source image: $SOURCE_IMAGE"
          echo "  Validators: ${{ inputs.validators }}"

          "${GITHUB_WORKSPACE}/build/devnet-builder" deploy \
            --home "$DEVNET_BASE_DIR" \
            --network "${{ inputs.snapshot_network }}" \
            --validators "${{ inputs.validators }}" \
            --mode docker \
            --image "$SOURCE_IMAGE" \
            --no-interactive \
            --verbose

      - name: Wait for chain to be ready
        run: |
          echo "Waiting for chain to start producing blocks..."
          TIMEOUT=300
          ELAPSED=0

          while [ $ELAPSED -lt $TIMEOUT ]; do
            sleep 10
            ELAPSED=$((ELAPSED + 10))

            STATUS=$(curl -s http://localhost:26657/status 2>/dev/null || echo '{}')
            HEIGHT=$(echo "$STATUS" | jq -r '.result.sync_info.latest_block_height // "0"')
            CATCHING_UP=$(echo "$STATUS" | jq -r 'if .result.sync_info.catching_up == null then true else .result.sync_info.catching_up end')

            echo "[${ELAPSED}s] Height: $HEIGHT, Catching up: $CATCHING_UP"

            if [ "$CATCHING_UP" = "false" ] && [ "$HEIGHT" -gt "0" ]; then
              echo "Chain is producing blocks!"
              break
            fi
          done

          # Wait for EVM JSON-RPC to be ready
          echo "Waiting for EVM JSON-RPC..."
          EVM_TIMEOUT=120
          EVM_ELAPSED=0

          while [ $EVM_ELAPSED -lt $EVM_TIMEOUT ]; do
            sleep 5
            EVM_ELAPSED=$((EVM_ELAPSED + 5))

            CHAIN_ID_RESULT=$(curl -s -X POST http://localhost:8545 \
              -H "Content-Type: application/json" \
              -d '{"jsonrpc":"2.0","method":"eth_chainId","params":[],"id":1}' 2>/dev/null || echo '{}')

            if echo "$CHAIN_ID_RESULT" | jq -e '.result' > /dev/null 2>&1; then
              echo "EVM JSON-RPC is ready!"
              break
            fi

            echo "[${EVM_ELAPSED}s] EVM RPC not ready yet..."
          done

      - name: Perform upgrade
        id: upgrade
        run: |
          UPGRADE_IMAGE="${STABLED_IMAGE}:${{ inputs.upgrade_image_tag }}"
          UPGRADE_NAME="${{ inputs.upgrade_name }}"

          echo "Performing upgrade..."
          echo "  Upgrade name: $UPGRADE_NAME"
          echo "  Target image: $UPGRADE_IMAGE"

          "${GITHUB_WORKSPACE}/build/devnet-builder" upgrade \
            --home "$DEVNET_BASE_DIR" \
            --name "$UPGRADE_NAME" \
            --image "$UPGRADE_IMAGE" \
            --export-genesis \
            --no-interactive \
            --verbose

      - name: Verify upgrade
        run: |
          echo "Verifying upgrade..."
          sleep 30

          "${GITHUB_WORKSPACE}/build/devnet-builder" status --home "$DEVNET_BASE_DIR"

          # Check chain is producing blocks
          STATUS=$(curl -s http://localhost:26657/status 2>/dev/null || echo '{}')
          HEIGHT=$(echo "$STATUS" | jq -r '.result.sync_info.latest_block_height // "0"')
          CATCHING_UP=$(echo "$STATUS" | jq -r 'if .result.sync_info.catching_up == null then true else .result.sync_info.catching_up end')

          echo "Current height: $HEIGHT"
          echo "Catching up: $CATCHING_UP"

          if [ "$CATCHING_UP" = "false" ] && [ "$HEIGHT" -gt "0" ]; then
            echo ""
            echo "=========================================="
            echo "UPGRADE SUCCESSFUL!"
            echo "=========================================="
          else
            echo "Warning: Chain may not be fully operational"
            docker logs devnet-node0 2>&1 | tail -50
          fi

      - name: Export account keys
        run: |
          echo "=========================================="
          echo "Account Keys"
          echo "=========================================="
          "${GITHUB_WORKSPACE}/build/devnet-builder" export-keys --home "$DEVNET_BASE_DIR" --json
          echo "=========================================="

      - name: Display summary
        run: |
          CHAIN_ID=$("${GITHUB_WORKSPACE}/build/devnet-builder" status --home "$DEVNET_BASE_DIR" --json 2>/dev/null | jq -r '.chain_id // "unknown"' || echo "unknown")

          echo ""
          echo "=========================================="
          echo "Devnet Upgrade Summary"
          echo "=========================================="
          echo "Network: ${{ inputs.snapshot_network }}"
          echo "Source Image: ${STABLED_IMAGE}:${{ inputs.source_image_tag }}"
          echo "Upgrade Image: ${STABLED_IMAGE}:${{ inputs.upgrade_image_tag }}"
          echo "Upgrade Name: ${{ inputs.upgrade_name }}"
          echo "Chain ID: $CHAIN_ID"
          echo "Validators: ${{ inputs.validators }}"
          echo "Directory: $DEVNET_BASE_DIR"
          echo ""
          echo "Endpoints:"
          echo "  RPC: http://localhost:26657"
          echo "  EVM JSON-RPC: http://localhost:8545"
          echo "  gRPC: localhost:9090"
          echo ""
          echo "Genesis snapshots saved to: $DEVNET_BASE_DIR/devnet/genesis-snapshots/"
          echo "=========================================="

      - name: Upload genesis snapshots
        uses: actions/upload-artifact@v4
        with:
          name: genesis-snapshots-${{ inputs.upgrade_name }}-${{ github.run_number }}
          path: ${{ env.DEVNET_BASE_DIR }}/devnet/genesis-snapshots/
          retention-days: 30

      - name: Logout from GitHub Container Registry
        if: always()
        run: |
          docker logout ghcr.io
